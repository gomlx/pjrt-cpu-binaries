name: "Build amazonlinux/amd64 XLA PJRT CPU Plugin (AL2023/Low Glibc)"

# This allows the workflow to be triggered manually from the GitHub UI
on:
  workflow_dispatch:

jobs:
  build-and-package-amazonlinux-amd64:
    name: "Build Amazon Linux 2023 (amd64) Plugin"

    # Use the Amazon Linux 2023 Docker container image
    runs-on: ubuntu-latest
    container: amazonlinux:2023

    steps:
      - name: "Install Minimal Action Tools (tar, git)"
        run: |
          dnf update -y
          dnf install -y tar git

      - name: "Checkout current repository"
        uses: actions/checkout@v4

      - name: "Install Build Toolchain and Python Environment (dnf)"
        run: |
          dnf install -y make python3 python3-pip python3-devel

      - name: "Install Python dependencies (numpy, six)"
        run: |
          pip3 install six numpy

      - name: "Setup Bazelisk (for Bazel)"
        uses: bazelbuild/setup-bazelisk@v3

      - name: "Check out openxla/xla repository"
        uses: actions/checkout@v4
        with:
          repository: "openxla/xla"
          path: "xla"
          submodules: "recursive"

      - name: "Download and Setup LLVM/Clang"
        run: |
          # --- Configuration: Adjust these variables for the desired LLVM release ---
          # NOTE: The file name must be verified on the LLVM GitHub releases page.
          LLVM_VERSION="21.1.7" # Example: A known stable version
          # Assuming the generic x86_64 Linux archive structure
          ARCHIVE_NAME="LLVM-${LLVM_VERSION}-Linux-X64.tar.xz"
          DOWNLOAD_URL="https://github.com/llvm/llvm-project/releases/download/llvmorg-${LLVM_VERSION}/${ARCHIVE_NAME}"
          INSTALL_DIR="/opt/llvm"

          echo "Downloading LLVM ${LLVM_VERSION} from GitHub releases..."
          curl -sSL --fail ${DOWNLOAD_URL} -o llvm_temp.tar.xz

          if [ $? -ne 0 ]; then
              echo "Error: Failed to download LLVM archive from ${DOWNLOAD_URL}. Check the URL and file name." >&2
              exit 1
          fi

          mkdir -p ${INSTALL_DIR}
          # Extract the contents and move the inner directory's contents to /opt/llvm
          # --strip-components=1 removes the top-level directory in the archive.
          tar -xf llvm_temp.tar.xz --strip-components=1 -C ${INSTALL_DIR}
          rm llvm_temp.tar.xz

          # Make sure the compiler is executable
          chmod +x ${INSTALL_DIR}/bin/*

      - name: "Build PJRT C API CPU plugin"
        run: |
          BUILDER_VERSION="$(cat BUILDER_VERSION.txt)"
          PJRT_C_API_HEADER="./xla/xla/pjrt/c/pjrt_c_api.h"
          MAJOR=$(grep -E '#define PJRT_API_MAJOR' "${PJRT_C_API_HEADER}" | awk '{print $3}')
          MINOR=$(grep -E '#define PJRT_API_MINOR' "${PJRT_C_API_HEADER}" | awk '{print $3}')
          echo "Building PJRT CPU plugin for version ${MAJOR}.${MINOR} (to be used in go-xla as v${MAJOR}.${MINOR}.${BUILDER_VERSION})"

          # Point Bazel to the system-installed Clang in AL2023
          export CC="/opt/llvm/bin/clang"
          export CXX="/opt/llvm/bin/clang++"
          export HERMETIC_PYTHON_VERSION=3.11

          cd xla
          printf "\nConfiguring XLA build:\n"
          ./configure.py --backend CPU --os LINUX --host_compiler CLANG --clang_path "${CC}"

          printf "\nStarting XLA bazel build:\n"
          bazel build -c opt //xla/service/cpu:runtime_matmul
          bazel build -c opt //xla/pjrt/c:pjrt_c_api_cpu_plugin.so

      - name: "Package the binary"
        run: |
          # Create the tarball.
          PJRT_C_API_HEADER="./xla/xla/pjrt/c/pjrt_c_api.h"
          TARBALL_NAME="pjrt_cpu_amazonlinux_amd64.tar.gz"
          BINARY_DIR="xla/bazel-bin/xla/pjrt/c"
          BINARY_NAME="pjrt_c_api_cpu_plugin.so"
          BUILDER_VERSION="$(cat BUILDER_VERSION.txt)"

          # 1. Extract the Major and Minor version numbers from the header file.
          MAJOR=$(grep -E '#define PJRT_API_MAJOR' "${PJRT_C_API_HEADER}" | awk '{print $3}')
          MINOR=$(grep -E '#define PJRT_API_MINOR' "${PJRT_C_API_HEADER}" | awk '{print $3}')
          if [[ -z "$MAJOR" || -z "$MINOR" ]]; then
              echo "Error: Could not extract PJRT API version from ${PJRT_C_API_HEADER}. Aborting." >&2
              exit 1
          fi

          # 2. Construct the full version string and the new filename.
          PJRT_VERSION="v${MAJOR}.${MINOR}.${BUILDER_VERSION}"
          NEW_BINARY_NAME="pjrt_c_api_cpu_amazonlinux_${PJRT_VERSION}_plugin.so"
          echo "Extracted PJRT Version: ${PJRT_VERSION}"
          echo "New Binary Name: ${NEW_BINARY_NAME}"
          mv "${BINARY_DIR}/${BINARY_NAME}" "${BINARY_DIR}/${NEW_BINARY_NAME}"

          # Package the new binary name
          tar -czvf ${TARBALL_NAME} -C ${BINARY_DIR} ${NEW_BINARY_NAME}
          echo "Successfully created ${TARBALL_NAME} containing ${NEW_BINARY_NAME}"

      - name: "Upload plugin artifact"
        uses: actions/upload-artifact@v4
        with:
          name: pjrt_cpu_amazonlinux_amd64
          path: pjrt_cpu_amazonlinux_amd64.tar.gz
          retention-days: 3
